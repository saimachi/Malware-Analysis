import os
import shutil
import csv
import magic
import git

def list_paths(root_tree, path=''):
    for blob in root_tree.blobs:
        yield blob.name if path == '' else f'{path}/{blob.name}'
    for tree in root_tree.trees:
        yield from list_paths(tree, tree.name if path == '' else f'{path}/{tree.name}')

if __name__ == '__main__':
    directory_path = '/home/sai/web-malware/website-682886'
    repo = git.Repo(directory_path)
    commit_metrics = []
    headers = []
    for commit in repo.iter_commits(reverse=True):
        repo.git.checkout(commit.hexsha)
        mime_type_counts = {}
        for file in list_paths(commit.tree):
            path = f'{directory_path}/{file}'
            mime_type = magic.from_file(path, mime=True)
            # Headers
            if mime_type not in headers:
                headers.append(mime_type)
            # Mime Type Counts
            if mime_type in mime_type_counts:
                mime_type_counts[mime_type] += 1
            else:
                mime_type_counts[mime_type] = 1
            # APKs & executables
            if file.split('/')[-1] != 'Jonco-2016-02-04T15-05-09.mysql.zip' and (mime_type == 'application/x-pie-executable' or mime_type == 'application/zip'):
                dest = f'./malicious/{commit.hexsha}'
                os.makedirs(dest)
                shutil.copy(path, dest)
        commit_metrics.append(
            {
                'hash': commit.hexsha,
                'metrics': mime_type_counts
            }
        )
    # Dump output in CSV
    with open('output.csv', 'w') as output_file:
        comparison_writer = csv.writer(output_file)
        comparison_writer.writerow(['Commit'] + headers)
        for commit in commit_metrics:
            frequency = [0 if mime not in commit['metrics'] else commit['metrics'][mime] for mime in headers]
            comparison_writer.writerow([commit['hash']] + frequency)
